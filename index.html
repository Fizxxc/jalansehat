  <!doctype html>
  <html lang="id">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registrasi Ulang - Festara</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <link rel="stylesheet" href="/styles/style.css">

    <style>
  /* Fade out transition */
  #pageLoader {
    transition: opacity .6s ease, transform .6s ease;
  }
</style>

  </head>

  <body class="bg-gradient-to-br from-indigo-50 via-blue-50 to-cyan-100 min-h-screen">

    <!-- LOADING OVERLAY -->
<div id="pageLoader"
  class="fixed inset-0 bg-gradient-to-br from-blue-100 via-white to-blue-200
         flex flex-col items-center justify-center z-[9999]">

  <!-- RING ANIMASI -->
  <div class="relative">
      <div class="w-20 h-20 border-4 border-blue-300 border-t-blue-600 rounded-full animate-spin"></div>

      <!-- ICON LORDICON DI TENGAH -->
      <div class="absolute inset-0 flex items-center justify-center">
        <lord-icon
          src="https://cdn.lordicon.com/soseozvi.json"
          trigger="loop"
          colors="primary:#1e3a8a"
          style="width:55px;height:55px">
        </lord-icon>
      </div>
  </div>

  <p class="mt-6 text-blue-800 font-semibold tracking-wide text-sm animate-pulse">
    Menyiapkan halaman untuk Anda...
  </p>
</div>

    <div class="max-w-xl mx-auto px-4 sm:px-6 pt-10 pb-16">

      <!-- LOGO + TITLE -->
      <div class="text-center mb-8">
        <img src="/assets/img/festara.png" 
          class="w-32 h-32 sm:w-40 sm:h-40 mx-auto drop-shadow-lg" 
          alt="Logo Festara">

        <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-800 mt-4 leading-tight">
          Registrasi Ulang Jalan Sehat
        </h1>

        <p class="text-gray-600 text-xs sm:text-sm mt-1">
          Masukkan nama untuk melakukan registrasi ulang.
        </p>
      </div>

      <!-- FORM INPUT -->
      <label class="block text-sm font-semibold text-gray-700">Nama lengkap</label>

      <div class="mt-2 flex flex-col sm:flex-row gap-3">
        <input id="searchName"
          class="flex-1 px-4 py-2 rounded-lg border w-full focus:ring-2 focus:ring-blue-400"
          placeholder="Contoh: Budi Setiawan" />

        <button id="btnSearch"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center sm:w-14">
          <lord-icon src="https://cdn.lordicon.com/vhdgmtyj.json" trigger="hover"
            colors="primary:#e4e4e4" style="width:28px;height:28px">
          </lord-icon>
        </button>
      </div>

      <div id="result" class="mt-5 hidden"></div>

      <!-- INFORMASI -->
      <div class="mt-8 text-center text-gray-600">
        <p class="text-xs sm:text-sm">Butuh verifikasi oleh panitia? Tunjukkan QR pada halaman sukses ke petugas.</p>
      </div>

      <!-- SPONSOR SECTION -->
      <div class="mt-12 overflow-hidden relative">
        <p class="text-center text-sm sm:text-base font-semibold mb-4 text-gray-700">Didukung oleh:</p>

        <div class="sponsor-slider flex items-center gap-10 py-2">

          <!-- DAFTAR LOGO (AUTO LOOP) -->
          <template id="logos">
            <img src="/assets/img/1.png" class="h-10 sm:h-12 grayscale hover:grayscale-0 transition" />
            <img src="/assets/img/2.png" class="h-10 sm:h-12 grayscale hover:grayscale-0 transition" />
            <img src="/assets/img/3.png" class="h-10 sm:h-12 grayscale hover:grayscale-0 transition" />
            <img src="/assets/img/4.png" class="h-10 sm:h-12 grayscale hover:grayscale-0 transition" />
            <img src="/assets/img/5.png" class="h-10 sm:h-12 grayscale hover:grayscale-0 transition" />
            <img src="/assets/img/6.png" class="h-10 sm:h-12 grayscale hover:grayscale-0 transition" />
            <img src="/assets/img/7.png" class="h-10 sm:h-12 grayscale hover:grayscale-0 transition" />
          </template>

          <!-- Copy 2x -->
          <div class="flex items-center gap-10" id="logoRow1"></div>
          <div class="flex items-center gap-10 ml-10" id="logoRow2"></div>

        </div>
      </div>

      <!-- FOOTER -->
      <footer class="mt-10 text-center text-xs text-gray-500">
        &copy; 2025 Festara. All rights reserved. |
        Dev <a href="https://www.instagram.com/fizzx.docx/" class="text-blue-900 font-bold">FizzxDevv</a>
      </footer>

    </div>

    <script>
    
    </script>

    <script type="module">
      import { db, storage } from '/firebase.js'; // pastikan path sesuai
      import { collection, getDocs, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
      import { ref, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

      const elName = document.getElementById('searchName');
      const btnSearch = document.getElementById('btnSearch');
      const result = document.getElementById('result');

      const norm = s => (s || '').toString().trim().toLowerCase();

      async function findParticipantByName(name) {
        // ambil seluruh peserta dan match case-insensitive pada field "nama"
        const snaps = await getDocs(collection(db, 'peserta'));
        const nrm = norm(name);
        for (const s of snaps.docs) {
          const data = s.data();
          if (norm(data.nama) === nrm) return { id: s.id, data };
        }
        return null;
      }

      btnSearch.addEventListener('click', async () => {
        const name = elName.value.trim();
        if (!name) return alert('Masukkan nama.');
        result.classList.add('hidden');
        result.innerHTML = '';

        const found = await findParticipantByName(name);
        if (!found) {
          result.classList.remove('hidden');
          result.innerHTML = `<div class="p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 font-semibold">‚ùå Nama tidak ada atau belum daftar. Hubungi panitia.</div>`;
          // optional: suara notifikasi bisa ditambahkan
          return;
        }

        // tampilkan info & tombol registrasi ulang
        result.classList.remove('hidden');
        result.innerHTML = `
        <div id="card" class="p-5 bg-white border rounded-lg shadow">
          <div class="flex justify-between items-start">
            <div>
              <div class="text-lg font-bold">${found.data.nama}</div>
              <div class="text-xs text-gray-500">ID: ${found.id}</div>
              <div class="mt-1 text-sm text-gray-600">HP: ${found.data.hp || '-'}</div>
            </div>
            <div>
              ${found.data.registered ? '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-lg">Sudah registrasi</span>' : '<button id="btnReg" class="px-3 py-1 bg-green-600 text-white rounded-lg">Registrasi Ulang</button>'}
            </div>
          </div>

          <div class="mt-4">
            <button id="btnScreenshot" class="px-3 py-2 bg-gray-800 text-white rounded-lg w-full">Ambil Screenshot Bukti</button>
          </div>
        </div>
      `;

        const btnReg = document.getElementById('btnReg');
        if (btnReg) {
          btnReg.addEventListener('click', async () => {
            // update peserta -> registered true
            await updateDoc(doc(db, 'peserta', found.id), {
              registered: true,
              registeredAt: new Date().toISOString()
            });
            // redirect ke halaman success (QR akan di-generate di success)
            localStorage.setItem('last_registered', found.id);
            window.location.href = '/success.html?id=' + encodeURIComponent(found.id);
          });
        }

        document.getElementById('btnScreenshot').addEventListener('click', async () => {
          const node = document.getElementById('card');
          const canvas = await html2canvas(node, { scale: 3, backgroundColor: null });
          const png = canvas.toDataURL('image/png');
          // upload ke storage sebagai bukti (opsional)
          const sref = ref(storage, `proofs/${found.id}_${Date.now()}.png`);
          await uploadString(sref, png.split(',')[1], 'base64', { contentType: 'image/png' });
          const url = await getDownloadURL(sref);
          alert('Screenshot tersimpan. URL:\n' + url);
        });
      });
      /* DUPLIKASI LOGO OTOMATIS UNTUK SLIDER */
      const logos = document.getElementById("logos").content;
      document.getElementById("logoRow1").appendChild(logos.cloneNode(true));
      document.getElementById("logoRow2").appendChild(logos.cloneNode(true));

  window.addEventListener("load", () => {
    const loader = document.getElementById("pageLoader");

    // Animasi keluar
    loader.style.opacity = "0";
    loader.style.transform = "scale(1.1)";

    setTimeout(() => loader.style.display = "none", 600);
  });

    </script>
  </body>

  </html>