<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registrasi Ulang - Sukses</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-green-50 min-h-screen flex items-center justify-center p-6">

  <div class="max-w-md w-full bg-white p-6 rounded-xl shadow-lg text-center">
    <h2 class="text-2xl font-bold text-green-800">Registrasi Ulang Berhasil ðŸŽ‰</h2>
    <p class="mt-3 text-gray-700">Anda berhak mendapatkan souvenir dari panitia.</p>

    <div class="mt-5">
      <div id="qrcode" class="mx-auto w-48 h-48"></div>
      <p class="mt-3 text-sm text-gray-600">Tunjukkan QR ini kepada panitia untuk verifikasi.</p>
    </div>

    <div class="mt-5 flex gap-2 justify-center">
      <button id="btnDownload" class="px-4 py-2 bg-blue-600 text-white rounded">Download QR</button>
      <a href="/" class="px-4 py-2 border rounded text-gray-700">Kembali</a>
    </div>

    <div class="mt-4 text-xs text-gray-500">Jika QR tidak muncul, hubungi devloper <a href="https://wa.me/6288991114939"></a>(+62 889-9111-4939).</div>
  </div>

<script type="module">
  import { db } from '/firebase.js';
  import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const params = new URLSearchParams(location.search);
  const id = params.get('id') || localStorage.getItem('last_registered');

  async function init() {
    if (!id) { document.body.innerHTML = '<p class="p-6">ID peserta tidak ditemukan.</p>'; return; }
    const d = await getDoc(doc(db, 'peserta', id));
    if (!d.exists()) { document.body.innerHTML = '<p class="p-6">Data peserta tidak ditemukan.</p>'; return; }
    const data = d.data();

    // show doorprize text already removed, show souvenir message (already in HTML)
    // generate QR with payload = peserta id (plain string)
    const qnode = document.getElementById('qrcode');
    const qr = new QRCode(qnode, {
      text: id,
      width: 200,
      height: 200,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });

    document.getElementById('btnDownload').onclick = () => {
      // convert QR canvas/svg to image and download
      const img = qnode.querySelector('img') || qnode.querySelector('canvas');
      if (!img) return alert('QR belum siap.');
      const src = (img.tagName === 'IMG') ? img.src : img.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = src;
      a.download = `qr_${id}.png`;
      a.click();
    };
  }

  init();
</script>
</body>
</html>
